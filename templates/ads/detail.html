{% extends "base.html" %}
{% block title %}{{ ad.title }} — {{ ad.brand.name }}{% endblock %}
{% block content %}
<h1>{{ ad.title }}</h1>
<p>{{ ad.brand.name }}{% if ad.year %} ({{ ad.year }}){% endif %}{% if ad.agency %} — Agency: {{ ad.agency.name }}{% endif %}</p>
<p>Rating: {% if ad.num_reviews %}★ {{ ad.avg_rating|floatformat:1 }} ({{ ad.num_reviews }}){% else %}No reviews yet{% endif %}</p>

{% if ad.youtube_id %}
  <div class="video-16x9">
    <iframe
      src="https://www.youtube-nocookie.com/embed/{{ ad.youtube_id }}?rel=0"
      title="{{ ad.title|escape }}"
      frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      referrerpolicy="strict-origin-when-cross-origin"
      allowfullscreen>
    </iframe>
  </div>
{% else %}
  <p><em>No video ID found.</em></p>
{% endif %}
<p>Tags:
{% for t in ad.tags_m2m.all %}
  <a href="{% url 'search' %}?tag={{ t.slug }}">{{ t.name }}</a>
{% empty %}—{% endfor %}
</p>

<h2>Reviews</h2>
{% for r in ad.reviews.all %}
  <article>
    <strong><a href="{% url 'profile_public' r.user.username %}">{{ r.user.username }}</a></strong>
    <p>{{ r.body|linebreaksbr }}</p>
    <small>{{ r.created_at }}</small>
  </article>
  <hr>
{% empty %}
  <p>No reviews yet.</p>
{% endfor %}

{% if user.is_authenticated %}
  <h3>{% if user_review %}Edit your review{% else %}Write a review{% endif %}</h3>
  <form method="post" action="{% url 'review_submit' ad.pk %}">
    {% csrf_token %}
    <label>Rating (0–5): {{ form.rating }}</label><br>
    <label>Thoughts:<br>{{ form.body }}</label><br>
    <button type="submit">{% if user_review %}Update{% else %}Submit{% endif %}</button>
  </form>
{% else %}
  <p><a href="/accounts/login/?next={{ request.path }}">Log in</a> to review.</p>
{% endif %}

<p><a href="{% url 'ad_list' %}">← Back to list</a></p>
{% endblock %}