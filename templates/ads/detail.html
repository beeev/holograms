{% extends "base.html" %}
{% block content %}
<h1>{{ ad.title }}</h1>
<p class="meta">
  <a href="{{ ad.brand.get_absolute_url }}">{{ ad.brand.name }}</a>
  {% if ad.year %} • {{ ad.year }}{% endif %}
  {% if ad.agency %} • <a href="{{ ad.agency.get_absolute_url }}">{{ ad.agency.name }}</a>{% endif %}
</p>

{% if ad.youtube_id %}
  <div class="video-16x9" style="margin:14px 0 18px;">
    <iframe
      src="https://www.youtube-nocookie.com/embed/{{ ad.youtube_id }}?rel=0"
      title="{{ ad.title|escape }}"
      loading="lazy"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      referrerpolicy="strict-origin-when-cross-origin"
      allowfullscreen></iframe>
  </div>
{% endif %}

<div class="badges">
  {% if ad.duration_sec %}<span class="badge">{{ ad.duration_sec }}s</span>{% endif %}
  {% if ad.reviews.all.count %}<span class="badge">★ {{ ad.reviews.all.aggregate|default_if_none:"" }}</span>{% endif %}
</div>

{% if ad.tags_m2m.all %}
  <div class="chips">
    {% for t in ad.tags_m2m.all %}
      <a class="chip" href="{% url 'search' %}?tag={{ t.slug }}">{{ t.name }}</a>
    {% endfor %}
  </div>
{% endif %}

{% if ad.credits.all %}
  <h2 style="margin-top:22px;">Credits</h2>
  <ul>
    {% for c in ad.credits.all %}
      <li>{{ c.get_role_display }} — {{ c.person.name }}{% if c.company %} ({{ c.company.name }}){% endif %}</li>
    {% endfor %}
  </ul>
{% endif %}

<h2 style="margin-top:22px;">Reviews</h2>
{% if user.is_authenticated %}
  <form method="post" action="{% url 'review_submit' ad.pk %}">
    {% csrf_token %}
    <label>Rating (0–5)</label>
    <input type="number" name="rating" min="0" max="5" step="1" style="width:70px">
    <br>
    <textarea name="body" rows="3" style="width:100%; margin-top:8px;" placeholder="What did you think?"></textarea>
    <button class="btn" type="submit" style="margin-top:8px;">Post review</button>
  </form>
{% else %}
  <p class="meta">Log in to review.</p>
{% endif %}
<ul>
  {% for r in ad.reviews.all %}
    <li><strong>★ {{ r.rating }}</strong> — {{ r.user.username }} <span class="meta">· {{ r.created_at|date:"Y-m-d" }}</span><br>{{ r.body|linebreaksbr }}</li>
  {% empty %}
    <li class="meta">No reviews yet.</li>
  {% endfor %}
</ul>
{% endblock %}